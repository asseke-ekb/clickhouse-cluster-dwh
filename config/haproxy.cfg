global
    log stdout format raw local0
    maxconn 4096

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    timeout connect 5000
    timeout client  50000
    timeout server  50000

listen stats
    bind *:8404
    mode http
    stats enable
    stats uri /
    stats refresh 10s
    stats show-legends

# ==================== ETL/Write endpoints - строгий приоритет ====================
frontend etl_http
    bind *:8080
    mode http
    default_backend clickhouse_etl_http

backend clickhouse_etl_http
    mode http
    balance first  # Всегда использует первый доступный сервер
    option httpchk GET /ping
    http-check expect status 200
    timeout server 600s
    # Строгий порядок: 01 → 02 → 03
    server clickhouse-01 clickhouse-01:8123 check inter 2000 rise 2 fall 3
    server clickhouse-02 clickhouse-02:8123 check inter 2000 rise 2 fall 3 backup
    server clickhouse-03 clickhouse-03:8123 check inter 2000 rise 2 fall 3 backup

# ==================== Analytics endpoints - равномерное распределение ====================
frontend analytics_http
    bind *:8081
    mode http
    default_backend clickhouse_analytics_http

backend clickhouse_analytics_http
    mode http
    balance leastconn
    option httpchk GET /ping
    http-check expect status 200
    timeout server 30s
    server clickhouse-01 clickhouse-01:8123 check inter 2000 rise 2 fall 3
    server clickhouse-02 clickhouse-02:8123 check inter 2000 rise 2 fall 3
    server clickhouse-03 clickhouse-03:8123 check inter 2000 rise 2 fall 3

# ==================== Reports endpoints - только Node02-03 ====================
frontend reports_http
    bind *:8082
    mode http
    default_backend clickhouse_reports_http

backend clickhouse_reports_http
    mode http
    balance source
    option httpchk GET /ping
    http-check expect status 200
    timeout server 1800s
    # Только read-оптимизированные ноды
    server clickhouse-02 clickhouse-02:8123 check inter 2000 rise 2 fall 3
    server clickhouse-03 clickhouse-03:8123 check inter 2000 rise 2 fall 3
    server clickhouse-01 clickhouse-01:8123 check inter 2000 rise 2 fall 3 backup

# ==================== TCP ETL endpoint - строгий приоритет ====================
frontend etl_tcp
    bind *:9090
    mode tcp
    default_backend clickhouse_etl_tcp

backend clickhouse_etl_tcp
    mode tcp
    balance first  # Всегда использует первый доступный
    option tcp-check
    timeout server 600s
    server clickhouse-01 clickhouse-01:9000 check inter 2000 rise 2 fall 3
    server clickhouse-02 clickhouse-02:9000 check inter 2000 rise 2 fall 3 backup
    server clickhouse-03 clickhouse-03:9000 check inter 2000 rise 2 fall 3 backup

# ==================== TCP Analytics endpoint ====================
frontend analytics_tcp
    bind *:9091
    mode tcp
    default_backend clickhouse_analytics_tcp

backend clickhouse_analytics_tcp
    mode tcp
    balance leastconn
    option tcp-check
    timeout server 30s
    server clickhouse-01 clickhouse-01:9000 check inter 2000 rise 2 fall 3
    server clickhouse-02 clickhouse-02:9000 check inter 2000 rise 2 fall 3
    server clickhouse-03 clickhouse-03:9000 check inter 2000 rise 2 fall 3


